<!DOCTYPE html>
<meta charset="utf-8">
<title>Video-Test</title>
<script src="../lib/shims.js"></script>
<link rel="stylesheet" href="../lib/qunit.css">
<script src="../lib/qunit.js"></script>

<div id="qunit"></div>

<script>
  QUnit.config.autostart = false;
  var require = { baseUrl: '../' };
</script>
<script src="../requireconfig.js"></script>
<script src="../lib/require.js"></script>

<script>
require(['renderStreamUrl', 'q'], function(renderStreamUrl, Q){

  test('Modul-API', function(){
    ok(typeof renderStreamUrl === 'function', 'Modul-API ist eine Funktion');
    equal(renderStreamUrl.length, 1, 'Modul-API akzeptiert ein Argument');
  });

  var testVideo = function successCallback(video){
    var $video = $(video);
    ok(true, 'Promise wird aufgelöst');
    ok($video.is('video'), 'Promise wird mit Video-Element aufgelöst');
    ok($video[0].paused === false, 'Zurückgegebenes Video wird abgespielt');
    $video[0].pause();
    $video.remove();
    start();
  };

  asyncTest('Rendern eines Videos von URL-String', function(){
    var source = 'assets/test.webm';
    var videoPromise = renderStreamUrl(source);
    ok(typeof videoPromise.then === 'function', 'Modul-API gibt ein Promise zurück');
    videoPromise.then(testVideo, function errorCallback(){
      throw new Error('Fehler: Promise wurde rejected!');
    })
  });

  asyncTest('Rendern eines Videos aus einem Promise', function(){
    var deferred = Q.defer();
    var videoPromise = renderStreamUrl(deferred.promise);
    ok(typeof videoPromise.then === 'function', 'Modul-API gibt ein Promise zurück');
    videoPromise.then(testVideo, function errorCallback(){
      throw new Error('Fehler: Promise wurde rejected!');
    })
    deferred.resolve('assets/test.webm');
  });

  asyncTest('Verarbeitung von ungültigen Quellen', function(){
    stop(3);
    var invalidSources = [
      42,
      "Hallo Welt",
      $('<div>')[0],
      null
    ];
    invalidSources.forEach(function(source){
      var videoPromise = renderStreamUrl(source);
      videoPromise.then(function successCallback(){
        throw new Error('Fehler: Promise wurde aufgelöst');
      }, function errorCallback(){
        ok(true, 'Ungültige Quellen werden abgelehnt');
        start();
      });
    });
  });

  QUnit.start();

});
</script>